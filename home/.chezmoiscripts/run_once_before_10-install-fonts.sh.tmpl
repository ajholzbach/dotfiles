{{- if or (eq .chezmoi.os "darwin") (eq .chezmoi.os "linux") -}}
#!/usr/bin/env bash
set -euo pipefail

if ! command -v curl >/dev/null 2>&1; then
    echo "Error: curl is required but not installed"
    echo "Please install curl and try again"
    exit 1
fi

echo "Installing MesloLGS Nerd Font..."

FONT_ARCHIVE_URL="https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Meslo.tar.xz"

{{- if eq .chezmoi.os "darwin" }}
FONT_DIR="$HOME/Library/Fonts"
{{- else if eq .chezmoi.os "linux" }}
FONT_DIR="$HOME/.local/share/fonts"
{{- end }}

if command -v brew >/dev/null 2>&1; then
    if brew list --cask font-meslo-lg-nerd-font >/dev/null 2>&1; then
        echo "MesloLGS Nerd Font already installed via Homebrew"
        exit 0
    fi

    echo "Installing MesloLGS Nerd Font via Homebrew..."
    brew tap homebrew/cask-fonts >/dev/null 2>&1 || true
    if brew install --cask font-meslo-lg-nerd-font; then
        echo "MesloLGS Nerd Font installed via Homebrew."
        exit 0
    else
        echo "Homebrew install failed, falling back to manual download..."
    fi
fi

existing_count=0
if [ -d "$FONT_DIR" ]; then
    existing_count=$(find "$FONT_DIR" -type f -name "MesloLGS*Nerd*Font*.ttf" 2>/dev/null | wc -l | tr -d ' ')
fi

if [ "$existing_count" -ge 4 ]; then
    echo "MesloLGS Nerd Font already installed in $FONT_DIR"
    exit 0
fi

mkdir -p "$FONT_DIR"

TMP_DIR="$(mktemp -d)"
cleanup() {
    rm -rf "$TMP_DIR"
}
trap cleanup EXIT

ARCHIVE_PATH="$TMP_DIR/Meslo.tar.xz"

echo "Downloading MesloLGS Nerd Font archive..."
if ! curl -fsSL -o "$ARCHIVE_PATH" "$FONT_ARCHIVE_URL"; then
    echo "Failed to download MesloLGS Nerd Font archive"
    exit 1
fi

if command -v tar >/dev/null 2>&1; then
    if ! tar -xf "$ARCHIVE_PATH" -C "$TMP_DIR"; then
        if command -v xz >/dev/null 2>&1; then
            if xz -dk "$ARCHIVE_PATH"; then
                if ! tar -xf "${ARCHIVE_PATH%.xz}" -C "$TMP_DIR"; then
                    echo "Failed to extract MesloLGS Nerd Font archive after xz decompression"
                    exit 1
                fi
            else
                echo "Failed to decompress MesloLGS Nerd Font archive with xz"
                exit 1
            fi
        else
            echo "Error: tar extraction failed and xz is not available. Please install xz."
            exit 1
        fi
    fi
elif command -v bsdtar >/dev/null 2>&1; then
    if ! bsdtar -xf "$ARCHIVE_PATH" -C "$TMP_DIR"; then
        echo "Failed to extract MesloLGS Nerd Font archive with bsdtar"
        exit 1
    fi
else
    echo "Error: tar or bsdtar is required to extract font archive"
    exit 1
fi

font_count=0
while IFS= read -r -d '' font_file; do
    cp -f "$font_file" "$FONT_DIR/"
    font_count=$((font_count + 1))
done < <(find "$TMP_DIR" -type f -name "*.ttf" -print0)

if [ "$font_count" -eq 0 ]; then
    echo "No fonts were extracted from the MesloLGS Nerd Font archive"
    exit 1
fi

{{- if eq .chezmoi.os "linux" }}
if command -v fc-cache >/dev/null 2>&1; then
    echo "Updating font cache..."
    fc-cache -f >/dev/null 2>&1 || true
fi
{{- end }}

echo "Installed $font_count MesloLGS Nerd Font files to $FONT_DIR"
{{- end }}
